<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 16px; font-size: 13px; }
    h1 { font-size: 16px; margin: 0 0 12px 0; }
    p { margin: 0 0 8px 0; }
    ul { margin: 0 0 12px 20px; padding: 0; }
    li { margin-bottom: 4px; }
    button { background-color: #0d99ff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: 600; }
    button:hover { background-color: #0b7dd1; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    #status { margin-top: 12px; color: #555; }
    .warning { background-color: #fffbe6; border: 1px solid #ffe58f; padding: 8px; border-radius: 4px; margin-top: 12px; }
    code { background: #eee; padding: 2px 4px; border-radius: 3px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
  <h1>WeasyPrint Exporter</h1>
  <p>Выберите один Frame и нажмите кнопку "Сгенерировать".</p>
  <p><b>Правила именования слоев:</b></p>
  <ul>
    <li>Текст: <code>{{ project_name }}</code>, <code>{{ project_description }}</code></li>
    <li>Контейнер для картинок: <code>{{#images}}</code></li>
    <li>Чтобы блок не разрывался на странице: добавьте <code>[no-break]</code> в имя слоя.</li>
  </ul>
  <button id="generate">Сгенерировать ZIP-архив</button>

  <div id="status"></div>

  <div id="font-warning" class="warning" style="display: none;">
    <h4>Внимание! Обнаружены шрифты:</h4>
    <ul id="font-list"></ul>
    <p>Убедитесь, что вы скачали файлы этих шрифтов (<code>.ttf</code>/<code>.otf</code>) и подключили их в <code>style.css</code> через <code>@font-face</code>.</p>
  </div>

<script>
  const generateBtn = document.getElementById('generate');
  const statusEl = document.getElementById('status');
  const fontWarningEl = document.getElementById('font-warning');
  const fontListEl = document.getElementById('font-list');

  generateBtn.onclick = () => {
    generateBtn.disabled = true;
    statusEl.textContent = 'Обработка...';
    fontWarningEl.style.display = 'none';
    fontListEl.innerHTML = '';
    parent.postMessage({ pluginMessage: { type: 'generate-html' } }, '*');
  };

  window.onmessage = async (event) => {
    const msg = event.data.pluginMessage;
    if (msg.type === 'generation-result') {
      statusEl.textContent = 'Создание ZIP-архива...';
      const { html, css, images, fonts, frameName } = msg.payload;

      const zip = new JSZip();
      zip.file('template.html', html);
      zip.file('style.css', css);

      if (images.length > 0) {
        const imgFolder = zip.folder("images");
        for (const image of images) {
          const byteCharacters = atob(image.bytes);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          imgFolder.file(image.name, byteArray);
        }
      }

      if (fonts.length > 0) {
        fonts.forEach(font => {
          const li = document.createElement('li');
          li.textContent = `${font.family} (Начертание: ${font.style})`;
          fontListEl.appendChild(li);
        });
        fontWarningEl.style.display = 'block';
      }

      const content = await zip.generateAsync({ type: "blob" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(content);
      link.download = `${frameName}.zip`;
      link.click();
      URL.revokeObjectURL(link.href);

      statusEl.textContent = 'Готово! Архив скачан.';
      generateBtn.disabled = false;

    } else if (msg.type === 'error') {
      statusEl.textContent = `Ошибка: ${msg.message}`;
      generateBtn.disabled = false;
    }
  };
</script>
</body>
</html>